--Pour inserer des dates depuis le format 2015-01-01 00:00:00 il faut utiliser la fonction STR_TO_DATE comme suit:
--STR_TO_DATE(date,'%Y-%m-%d %T')
--rempalcer date par la date a inserer


-- durée d'occupation des salles
SELECT accueil.nom_salle AS 'Nom salle', SUM(MINUTE(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))+(MINUTE(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))/60)) AS TempsEnHeure
FROM creneau
INNER JOIN accueil
ON creneau.id_creneau = accueil.id_creneau
WHERE creneau.heure_debut >= STR_TO_DATE('$DateDebut', "%d/%m/%Y") and creneau.heure_fin <= STR_TO_DATE('$DateFin', "%d/%m/%Y")
GROUP BY accueil.nom_salle
ORDER BY SUM(creneau.heure_fin - creneau.heure_debut) DESC;


-- durée d'occupation des salles pour un département donné
SELECT accueil.nom_salle AS "Nom de la salle", SUM(MINUTE(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))+(MINUTE(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))/60)) AS TempsPasserDansUneSalle
FROM creneau
INNER JOIN accueil
ON creneau.id_creneau = accueil.id_creneau
INNER JOIN participer
ON creneau.id_creneau = participer.id_creneau
INNER JOIN groupe
ON participer.nom_groupe = groupe.nom_groupe
WHERE nom_departement = '$Departement' 
and creneau.heure_debut >= STR_TO_DATE('$DateDebut', "%d/%m/%Y") and creneau.heure_fin <= STR_TO_DATE('$DateFin', "%d/%m/%Y")
GROUP BY fdesaintpalais.accueil.nom_salle
ORDER BY TempsPasserDansUneSalle DESC;
-- departement parmis ceux la 
-- Informatique
-- GEA
-- Information communication
-- QLIO
-- Carrieres juridiques
-- Null

-- MINUTE(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))+(MINUTE(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))/60)



-- durée d'occupation des salles par département
SELECT groupe.nom_departement AS 'Nom departement', SUM(MINUTE(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))+(MINUTE(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))/60)) AS TempsPasserDansSalle
FROM creneau
INNER JOIN accueil
ON creneau.id_creneau = accueil.id_creneau
INNER JOIN participer
ON creneau.id_creneau = participer.id_creneau
INNER JOIN groupe
ON participer.nom_groupe = groupe.nom_groupe
WHERE creneau.heure_debut >= STR_TO_DATE('$DateDebut', "%d/%m/%Y") and creneau.heure_fin <= STR_TO_DATE('$DateFin', "%d/%m/%Y")
GROUP BY groupe.nom_departement
ORDER BY TempsPasserDansSalle DESC;


-- Moyenne et dispersion de la durée d’occupation d’une salle par jour de la semaine
-- Il faut faire la somme des heure de cours dans la salle par jour et diviser par le nombre de jour de la période.
-- WEEKDAY
SELECT DAYNAME(creneau.heure_debut) AS JourDeLaSemaine, 
AVG(MINUTE(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))+(MINUTE(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))/60)) AS TempsOccupationMoyen
FROM creneau
GROUP BY WEEKDAY(creneau.heure_debut);


SELECT DAYNAME(creneau.heure_debut) AS JourDeLaSemaine, 
SUM(MINUTE(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))+(MINUTE(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))/60)) AS TempsOccupationMoyen
FROM salle
JOIN accueil
ON salle.nom_salle = accueil.nom_salle
JOIN creneau
ON creneau.id_creneau = accueil.id_creneau
WHERE salle.nom_salle = '$Salle' 
and creneau.heure_debut >= STR_TO_DATE('$DateDebut', "%d/%m/%Y") and creneau.heure_fin <= STR_TO_DATE('$DateFin', "%d/%m/%Y")
GROUP BY WEEKDAY(creneau.heure_debut);

SELECT DAYNAME(creneau.heure_debut) AS JourDeLaSemaine, 
       SUM(MINUTE(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))+(MINUTE(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))/60))/(COUNT(creneau.heure_debut)/7)
       AS TempsOccupationMoyen
FROM salle
JOIN accueil
ON salle.nom_salle = accueil.nom_salle
JOIN creneau
ON creneau.id_creneau = accueil.id_creneau
WHERE salle.nom_salle = 'A304'
and creneau.heure_debut >= STR_TO_DATE('$DateDebut', "%d/%m/%Y") and creneau.heure_fin <= STR_TO_DATE('$DateFin', "%d/%m/%Y")
GROUP BY WEEKDAY(creneau.heure_debut);


CREATE OR REPLACE VIEW NbHeureParSalleParJour AS
SELECT FROM_DAYS(TO_DAYS(creneau.heure_debut)) AS UnJour ,  salle.nom_salle,
      SUM(MINUTE(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))+(MINUTE(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))/60))/(COUNT(creneau.heure_debut)/7)
       AS Temps

FROM salle
JOIN accueil ON salle.nom_salle = accueil.nom_salle
JOIN creneau ON creneau.id_creneau = accueil.id_creneau
WHERE creneau.heure_debut >= STR_TO_DATE('03/02/2022', "%d/%m/%Y") and creneau.heure_fin <= STR_TO_DATE('05/09/2023', "%d/%m/%Y")
GROUP BY FROM_DAYS(TO_DAYS(creneau.heure_debut)),salle.nom_salle;
SELECT  DayName(Vue.UnJour) AS JourDeLaSemaine, AVG(Vue.Temps)
FROM NbHeureParSalleParJour Vue
WHERE Vue.nom_salle = 'A304'
GROUP  BY WEEKDAY(Vue.UnJour);


-- Charge (durée totale d’enseignements) moyenne hebdomadaire pour un groupe donné
SELECT ROUND(AVG(TIMEDIFF(creneau.heure_fin, creneau.heure_debut)) / 3600, 2) AS duree, participer.*, WEEK(creneau.heure_debut) AS semaine
FROM creneau
INNER JOIN participer
ON participer.id_creneau = creneau.id_creneau
WHERE participer.nom_groupe = 'B1CJCM'
GROUP BY WEEK(creneau.heure_debut)


-- Pour un département donné, proportion d’occupation de salles informatiques

-- SUM(TIMESTAMPDIFF(MINUTE, creneau.heure_debut, creneau.heure_fin)) / 

SELECT DISTINCT (
    SUM(TIMESTAMPDIFF(MINUTE, creneau.heure_debut, creneau.heure_fin))
	/
    (
        SELECT DISTINCT 
        SUM(TIMESTAMPDIFF(MINUTE, creneau.heure_debut, creneau.heure_fin))
        FROM creneau
        INNER JOIN participer
        ON creneau.id_creneau = participer.id_creneau
        INNER JOIN groupe
        ON groupe.nom_groupe = participer.nom_groupe
        WHERE groupe.nom_departement = '$Departement'
        AND creneau.heure_debut >= STR_TO_DATE('$DateDebut', '%d/%m/%Y')
        AND creneau.heure_fin   <= STR_TO_DATE('$DateFin'  , '%d/%m/%Y')
    )
) AS proportionOccupation
FROM creneau
INNER JOIN participer
ON creneau.id_creneau = participer.id_creneau
INNER JOIN groupe
ON groupe.nom_groupe = participer.nom_groupe
INNER JOIN accueil
ON accueil.id_creneau = creneau.id_creneau
INNER JOIN salle
ON salle.nom_salle = accueil.nom_salle
WHERE groupe.nom_departement = '$Departement'
AND creneau.heure_debut >= STR_TO_DATE('$DateDebut', '%d/%m/%Y')
AND creneau.heure_fin   <= STR_TO_DATE('$DateFin'  , '%d/%m/%Y')
AND salle.est_informatique = 'oui'

