-- durée d'occupation des salles
SELECT accueil.nom_salle AS 'Nom salle', SUM(HOUR(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))+(MINUTE(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))/60)) AS TempsEnHeure
FROM creneau
INNER JOIN accueil
ON creneau.id_creneau = accueil.id_creneau
WHERE creneau.heure_debut >= STR_TO_DATE('$DateDebut', "%d/%m/%Y") AND creneau.heure_fin <= STR_TO_DATE('$DateFin', "%d/%m/%Y")
GROUP BY accueil.nom_salle
ORDER BY SUM(creneau.heure_fin - creneau.heure_debut) DESC;

-- durée d'occupation des salles pour un département donné
SELECT accueil.nom_salle AS "Nom de la salle", SUM(HOUR(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))+(MINUTE(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))/60)) AS TempsPasserDansUneSalle
FROM creneau
INNER JOIN accueil
ON creneau.id_creneau = accueil.id_creneau
INNER JOIN participer
ON creneau.id_creneau = participer.id_creneau
INNER JOIN groupe
ON participer.nom_groupe = groupe.nom_groupe
WHERE nom_departement = '$Departement'
AND creneau.heure_debut >= STR_TO_DATE('$DateDebut', "%d/%m/%Y") AND creneau.heure_fin <= STR_TO_DATE('$DateFin', "%d/%m/%Y")
GROUP BY fdesaintpalais.accueil.nom_salle
ORDER BY TempsPasserDansUneSalle DESC;

-- durée d'occupation des salles par département
SELECT groupe.nom_departement AS 'Nom departement', SUM(HOUR(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))+(MINUTE(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))/60)) AS TempsPasserDansSalle
FROM creneau
INNER JOIN accueil
ON creneau.id_creneau = accueil.id_creneau
INNER JOIN participer
ON creneau.id_creneau = participer.id_creneau
INNER JOIN groupe
ON participer.nom_groupe = groupe.nom_groupe
WHERE creneau.heure_debut >= STR_TO_DATE('$DateDebut', "%d/%m/%Y") AND creneau.heure_fin <= STR_TO_DATE('$DateFin', "%d/%m/%Y")
GROUP BY groupe.nom_departement
ORDER BY TempsPasserDansSalle DESC;

-- Moyenne et dispersion de la durée d’occupation d’une salle par jour de la semaine
CREATE OR REPLACE VIEW NbHeureParSalleParJour AS
SELECT FROM_DAYS(TO_DAYS(creneau.heure_debut)) AS UnJour ,
       salle.nom_salle,
       SUM(HOUR(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))+(MINUTE(TIMEDIFF(creneau.heure_fin, creneau.heure_debut))/60))/(COUNT(creneau.heure_debut)/7) AS Temps
FROM salle
JOIN accueil ON salle.nom_salle = accueil.nom_salle
JOIN creneau ON creneau.id_creneau = accueil.id_creneau
GROUP BY FROM_DAYS(TO_DAYS(creneau.heure_debut)),salle.nom_salle;

SELECT  DayName(Vue.UnJour) AS JourDeLaSemaine, AVG(Vue.Temps) AS MoyenneDesHeures ,VARIANCE(Vue.Temps) AS VarianceDesHeures ,STDDEV(Vue.Temps) AS EcartTypeDesHeures
FROM NbHeureParSalleParJour Vue
WHERE Vue.nom_salle = 'A304'
AND Vue.UnJour >= STR_TO_DATE('05/09/2022', "%d/%m/%Y") AND Vue.UnJour <= STR_TO_DATE('05/10/2022', "%d/%m/%Y")
GROUP  BY WEEKDAY(Vue.UnJour);

-- Charge (durée totale d’enseignements) moyenne hebdomadaire pour un groupe donné
SELECT CONCAT(Cast(WEEK(creneau.heure_debut) AS CHARACTER),'°') AS 'Numero de semaine', ROUND(AVG(TIMEDIFF(creneau.heure_fin, creneau.heure_debut)) / 3600, 2) AS duree
FROM creneau
INNER JOIN participer
ON participer.id_creneau = creneau.id_creneau
WHERE participer.nom_groupe = 'B1CJCM'
AND creneau.heure_debut >= STR_TO_DATE('$DateDebut', "%d/%m/%Y") AND creneau.heure_fin <= STR_TO_DATE('$DateFin', "%d/%m/%Y")
GROUP BY WEEK(creneau.heure_debut)
ORDER BY WEEK(creneau.heure_debut) 

-- Pour un département donné, proportion d’occupation de salles informatiques

SELECT DISTINCT (
    SUM(TIMESTAMPDIFF(MINUTE, creneau.heure_debut, creneau.heure_fin))
	/
    (
        SELECT DISTINCT 
        SUM(TIMESTAMPDIFF(MINUTE, creneau.heure_debut, creneau.heure_fin))
        FROM creneau
        INNER JOIN participer
        ON creneau.id_creneau = participer.id_creneau
        INNER JOIN groupe
        ON groupe.nom_groupe = participer.nom_groupe
        WHERE groupe.nom_departement = '$Departement'
        AND creneau.heure_debut >= STR_TO_DATE('$DateDebut', '%d/%m/%Y')
        AND creneau.heure_fin   <= STR_TO_DATE('$DateFin'  , '%d/%m/%Y')
    )
) AS proportionOccupation
FROM creneau
INNER JOIN participer
ON creneau.id_creneau = participer.id_creneau
INNER JOIN groupe
ON groupe.nom_groupe = participer.nom_groupe
INNER JOIN accueil
ON accueil.id_creneau = creneau.id_creneau
INNER JOIN salle
ON salle.nom_salle = accueil.nom_salle
WHERE groupe.nom_departement = '$Departement'
AND creneau.heure_debut >= STR_TO_DATE('$DateDebut', '%d/%m/%Y') AND creneau.heure_fin   <= STR_TO_DATE('$DateFin'  , '%d/%m/%Y')
AND salle.est_informatique = 'oui'
