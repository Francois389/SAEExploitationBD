import Creneau
import re as regex


class Calendrier:
    def __init__(self, url : str) -> None:
        self.url_fichier = url
        self.liste_evenements = []

    def get_data(self):
        self.liste_evenements = parse_data(self.url_fichier)
    
    def get_events(self):
        return self.liste_evenements



def parse_data(url : str) -> list:
    """
    arguments :
        url -> str : l'url du fichier a lire

    TODO commenter cette merde

    retours :
        liste_retours -> list : la liste de tous les creneaux du calendrier

    """

    liste_retour = []
    data_bloc = {}
    with open(url, encoding="utf-8") as fichier:
        liste_lignes = fichier.readlines()[0:200]
        
        for ligne in liste_lignes:
            
            # lorsque le creneau commence
            if ligne.startswith("BEGIN:VEVENT"):
                data_bloc = {}

            # recuperation de la date de debut
            if ligne.startswith("DTSTART"):
                data_bloc["debut"] = ligne[8:-1]
            
            elif ligne.startswith("DTEND"):
                data_bloc["fin"] = ligne[6:-1]

            # recuperation de la salle
            elif ligne.startswith("LOCATION"):
                if ligne[9:-1] == "":
                    # gestion du cas ou la salle n'existe pas

                    data_bloc["salle"] = "Null"
                else:
                    data_bloc["salle"] = ligne[9:-1]
            
            # recuperation de la date de l'intitule
            elif ligne.startswith("SUMMARY"):
                data_bloc["intitule"] = ligne[8:-1]

            # recuperation de la date du professeur et du groupe
            elif ligne.startswith("DESCRIPTION"):
                prof, groupe = get_prof_groupe(ligne=ligne)

                if prof == []:
                    data_bloc["professeur"] = "Null"
                else:
                    data_bloc["professeur"] = ', '.join(prof)
                
                if groupe == []:
                    data_bloc["groupe"] = "Null"
                else:
                    data_bloc["groupe"] = ', '.join(groupe)

            # la fin du creneau
            elif ligne.startswith("END:VEVENT"):
                # on crée un nouveau creneau et avec le dictionnaire data_bloc
                # on ajoute les données du bloc dedans
                # on l'ajoute ensuite a la liste des creneaux du calendrier
                bloc = Creneau.Creneau()
                bloc.ajout_donnees(dico=data_bloc)
                liste_retour.append(bloc)
        
        return liste_retour



LISTE_DES_PROFS = []
with open("data/enseignants.txt", encoding="utf-8") as fichier_professeur:
    for prof in fichier_professeur.readlines(): 
        LISTE_DES_PROFS.append(prof.removesuffix("\n"))

LISTE_DES_GROUPES = []        
with open("data/groupes.txt", encoding="utf-8") as fichier_groupes:
    for grp in fichier_groupes.readlines():
        LISTE_DES_GROUPES.append(grp.split("\t")[0])

def get_prof_groupe(ligne : str) -> tuple:
    """
    arguments : 
        ligne -> str : une ligne DESCRIPTION du fichier ical

    
    pour recuperer les informations, on utilise une ReGex qui analyse la ligne
    elle passe outre les '\n' pour se concentrer sur le groupe et le professeur.
    Il peut y avoir de 0 a 2 groupes et de 0 a 2 professeurs.

    retours :
        -> (professeur, groupe_eleve) : le professeur et le groupe
    """


    test = ligne.split("\\n")

    groupes_liste = [elt for elt in test if elt in LISTE_DES_GROUPES]

    professeurs_liste = [elt for elt in test if elt in LISTE_DES_PROFS]            

    # print(professeurs_liste, groupes_liste)

    return professeurs_liste, groupes_liste
