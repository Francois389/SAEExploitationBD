from classes.Bloc import Bloc
from classes.donnees import LISTE_DES_NOMS_PROFS, LISTE_DES_NOMS_GROUPES

class Calendrier:
    """
    Classe permettant d'analyser le fichier .ics afin d'en récupérer tous les Blocs
    """
    
    def __init__(self, url: str) -> None:
        self.url_fichier = url
        self.liste_evenements = [Bloc]

    def get_data(self, limite: int = -1):
        self.liste_evenements = parse_data(self.url_fichier, limite=limite)
    
    def get_events(self):
        return self.liste_evenements



def parse_data(url: str, limite: int) -> list:
    """
    arguments :
        url -> str : l'url du fichier a lire

    retours :
        liste_retours -> list : la liste de tous les creneaux du calendrier

    """

    liste_retour = []
    data_bloc = {}

    with open(url, encoding="utf-8") as fichier:
        liste_lignes = fichier.readlines()[0:limite]
        
        for i, ligne in enumerate(liste_lignes):

            # TODO Créer des fonctions pour chaque cas
            ligne = ligne.replace(";", ",")
            
            # lorsque le creneau commence
            if ligne.startswith("BEGIN:VEVENT"):
                data_bloc = {
                    "creneau": {
                        "id"      : None,
                        "intitule": None,
                        "debut"   : None,
                        "fin"     : None,
                    },
                    "professeur"  : None,
                    "groupe"      : None, 
                    "salle"       : None,
                }

            # recuperation de la date de debut
            if ligne.startswith("DTSTART"):
                data_bloc["creneau"]["debut"] = ligne[8:-1]
            
            elif ligne.startswith("DTEND"):
                data_bloc["creneau"]["fin"] = ligne[6:-1]

            # recuperation de la salle
            elif ligne.startswith("LOCATION"):
                ligne = ligne.replace("\n", "").replace(",", "").replace("\\", ",")
                nouvelle_ligne = ligne[9:].split(",")

                if nouvelle_ligne[0] == "":
                    # gestion du cas ou la salle n'existe pas
                    data_bloc["salle"] = ["Null"]

                else:
                    data_bloc["salle"] = nouvelle_ligne
            
            # recuperation de la date de l'intitule
            #TODO Récupere si plusieur intitule dans la ligne. Ils sont séparé par un "\;"
            elif ligne.startswith("SUMMARY"):
                data_bloc["creneau"]["intitule"] = ligne[8:].removesuffix("\n")

            # recuperation de la date du professeur et du groupe
            elif ligne.startswith("DESCRIPTION"):
                ligne_complete: str = ""
                indice_temporaire = 0
                indice_temporaire += i
                
                while not ("UID" in liste_lignes[indice_temporaire]):
                    ligne_complete = ligne_complete + liste_lignes[indice_temporaire]
                    indice_temporaire += 1

                prof, groupe = get_prof_groupe(ligne=ligne_complete)

                if prof == []:
                    data_bloc["professeur"] = "Null"
                else:
                    data_bloc["professeur"] = prof

                if groupe == []:
                    data_bloc["groupe"] = "Null"
                else:
                    data_bloc["groupe"] = ', '.join(groupe)

            elif ligne.startswith("UID"):
                data_bloc["creneau"]["id"] = ligne[4:].removesuffix("\n")

            # la fin du creneau
            elif ligne.startswith("END:VEVENT"):
                # on crée un nouveau creneau et avec le dictionnaire data_bloc
                # on ajoute les données du bloc dedans
                # on l'ajoute ensuite a la liste des creneaux du calendrier
                bloc: Bloc = Bloc(data_bloc)
                liste_retour.append(bloc)
        
        return liste_retour


def get_prof_groupe(ligne: str) -> tuple:
    """
    arguments : 
        ligne -> str : une ligne DESCRIPTION du fichier ical

    
    pour recuperer les informations, on utilise un split qui analyse la ligne
    elle passe outre les '\n' pour se concentrer sur le groupe et le professeur.
    Il peut y avoir de 0 a plusieurs groupes et de 0 a plusieurs professeurs.

    retours :
        -> (professeur, groupe_eleve) : le professeur et le groupe
    """

    ligne_analysee = ligne.replace("\\;", " ").split("\\n")

    # listes en compréhension
    groupes_liste = [element for element in ligne_analysee if element in LISTE_DES_NOMS_GROUPES]

    professeurs_liste = [element for element in ligne_analysee if element in LISTE_DES_NOMS_PROFS]

    return professeurs_liste, groupes_liste
